# Project 4: Thread Local Storage
For this project, I implemented a thread local storage which allows each thread to have their own individual memory to write and read from, without interferring with other threads. To do this, I allocated an array of pointers to pages using calloc, and then allocated memory for each individual page using mmap. I used mmap because it allocates memory in a page-aligned way, which is important for tls. Each page gets protected using mprotect, ensuring no threads can read/write to it when they aren't supposed to. The pages are unprotected momentarily when performing tls_read and tls_write. For shared pages, the number of pages referencing a page is tracked via ref_count. If a thread tries to write to a page which is referenced by 1 or more other threads, a private copy of this page is created for the writing thread, and the original page is preserved. This private copy can be written to by the writing thread, but this does not impact the original page. Pages may be "shared" via tls_clone, which allows a currently running thread to copy another thread's tls.
The biggest challenge I faced when doing this project was trying to get the index of the currently running thread. I initially thought that I could simply use a global variable to keep track of this, as I did in project3. However, since I am not using my project3 library for this project, and instead am using Linux's pthread implementation, this approach did not work. I then changed the current thread to simply call pthread_self(), and the issue was resolved. This caused me some trouble at the start, but after fixing this error the rest of the project went smoothly.